@page "/mytome"
@using TomeKeeper.Components
@using TomeKeeper.Enums
@using TomeKeeper.Models
@using TomeKeeper.ViewModels
@using TomeKeeper.Services
@inject IAPIService _ApiService
@inject ITextFormatterService _TextFormatterService
@inject SavedSpellsService SavedSpellsService;
@inject SpellDetailsCacheService SpellDetailsCacheService;

<PageTitle>My Spellbook</PageTitle>

<div class="page-banner">
    <h1>My Spellbook</h1>
</div>

@if (_spellList.Any())
{
    <MudExpansionPanels
        MultiExpansion="true">
        <Virtualize Items="@_spellList" Context="spell" ItemSize="48">
            <ItemContent>
                <ExpandableScroll SpellListItem="spell"
                    ScrollMode="@ExpandableScrollMode.PersonalTome"/>
            </ItemContent>
        </Virtualize>
    </MudExpansionPanels>
}

@code {
    private IList<SpellListItem> _spellList = SavedSpellsService.SavedSpellListItems;
    private string _selectedSpellIndex { get; set; } = string.Empty;
    private SpellDetails _selectedSpellDetails { get; set; } = new();
    private SpellDetailsViewModel _spellDetailsViewModel { get; set; } = new();
    private bool _isLoadingDetails { get; set; } = false;

    private async Task OnGetSpellDetailsClick(string spellIndex)
    {
        if (_selectedSpellIndex == spellIndex)
        {
            _selectedSpellIndex = string.Empty;
            _selectedSpellDetails = new();
        }
        else
        {
            try
            {
                _isLoadingDetails = true;
                await GetSpellDetailsViewModelFromIndex(spellIndex);
            }
            finally
            {
                _isLoadingDetails = false;
            }

        }
    }

    private async Task GetSpellDetailsViewModelFromIndex(string spellIndex)
    {
        if (SpellDetailsCacheService.CachedSpells.Any(x => x.Index == spellIndex))
        {
            _spellDetailsViewModel = SpellDetailsCacheService.CachedSpells.First(x => x.Index == spellIndex);
            _selectedSpellIndex = spellIndex;
            return;
        }

        _selectedSpellIndex = spellIndex;
        var spellDetails = await _ApiService.GetSpellDetails(spellIndex);
        _spellDetailsViewModel = new SpellDetailsViewModel(spellDetails);
        if (!SpellDetailsCacheService.CachedSpells.Contains(_spellDetailsViewModel))
        {
            SpellDetailsCacheService.CachedSpells.Add(_spellDetailsViewModel);
        }
    }
}
