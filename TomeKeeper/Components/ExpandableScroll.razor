@using TomeKeeper.Enums
@using TomeKeeper.Models
@using TomeKeeper.Services
@using TomeKeeper.ViewModels

@inject ITextFormatterService _TextFormatterService

<div class="position-relative mb-2 w-100 px-1">
    @* Left Pill-Cap *@
    <div class="pill-cap left-semi position-absolute"
         style="left: -10px; top: 4px; height: 40px; width: 20px; z-index: 1;"></div>

    <MudExpansionPanel Class="flex-grow-1 flex-shrink-1 rounded-lg"
                       Style="min-width: 0; background-color: #f5deb3; z-index: 2;"
                       ExpandedChanged="SetSpellDetailsViewModel">
        <TitleContent>
            <div class="d-flex justify-space-between align-center">
                <MudText>@SpellListItem?.Name</MudText>
                @if (_expandableScrollViewModel.ScrollState != ScrollState.NoAction)
                {
                    <MudIconButton Icon="@GetIcon()"
                                   Color="@GetColor()"
                                   OnClick="HandleOnClick"
                                   Size="Size.Small" />
                }
            </div>
        </TitleContent>
        <ChildContent>
            <MudText>@_expandableScrollViewModel.SpellDetailsViewModel.SchoolLevelClassesString</MudText>
            <br />
            <MudText><b>Casting Time: </b>@_expandableScrollViewModel.SpellDetailsViewModel.CastingTimeString</MudText>
            <MudText><b>Range: </b> @_expandableScrollViewModel.SpellDetailsViewModel.Range</MudText>
            <MudText><b>Components: </b> @_expandableScrollViewModel.SpellDetailsViewModel.ComponentsString</MudText>
            <MudText><b>Duration: </b> @_expandableScrollViewModel.SpellDetailsViewModel.DurationString</MudText>
            <br />
            @if (_expandableScrollViewModel.SpellDetailsViewModel.Desc.Any())
            {
                @foreach (var desc in _expandableScrollViewModel.SpellDetailsViewModel.Desc)
                {
                    var formattedDesc = @_TextFormatterService.FormatBoldWords(desc);
                    <p>@((MarkupString)formattedDesc)</p>
                }
            }
        </ChildContent>
    </MudExpansionPanel>


    @* Right Pill-Cap *@
    <div class="pill-cap right-semi position-absolute"
         style="right: -10px; top: 4px; height: 40px; width: 20px; z-index: 1;"></div>
</div>

@code {

    private IExpandableScrollViewModel _expandableScrollViewModel;

    [Parameter]
    public SpellListItem SpellListItem
    {
        get => _expandableScrollViewModel.SpellListItem;
        set
        {
            _expandableScrollViewModel.SpellListItem = value;
        }
    }

    [Parameter]
    public ExpandableScrollMode ScrollMode
    {
        get
        {
            return _expandableScrollViewModel.ScrollMode;
        }
        set
        {
            _expandableScrollViewModel.ScrollMode = value;
        }
    }

    [Parameter]
    public EventCallback OnScrollExpanded { get; set; } = new();

    public ExpandableScroll(IExpandableScrollViewModel expandableScrollViewModel)
    {
        _expandableScrollViewModel = expandableScrollViewModel;
    }

    private async Task SetSpellDetailsViewModel(bool expanded)
    {
        if (expanded)
        {
            _ = _expandableScrollViewModel.SetSpellDetailsViewModel(SpellListItem.Index);
        }
    }

    private async Task HandleOnClick()
    {
        return;
    }

    private string GetIcon() => _expandableScrollViewModel.ScrollState switch
    {
        ScrollState.Add => Icons.Material.Filled.Add,
        ScrollState.Added => Icons.Material.Filled.Check,
        ScrollState.Remove => Icons.Material.Filled.Remove,
        _ => ""
    };

    //TODO: these colors don't match the theme
    private Color GetColor() => _expandableScrollViewModel.ScrollState switch
    {
        ScrollState.Add => Color.Success,
        ScrollState.Added => Color.Success,
        ScrollState.Remove => Color.Error,
        _ => Color.Default
    };

}
