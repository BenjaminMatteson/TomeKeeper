@page "/"
@using TomeKeeper.Components
@using TomeKeeper.Models
@using TomeKeeper.ViewModels
@using TomeKeeper.Services
@using TomeKeeper.Enums;
@rendermode InteractiveWebAssembly
@inject IAPIService _ApiService
@inject ITextFormatterService _TextFormatterService
@inject ISpellListItemsCacheService SpellListItemsCacheService;
@inject DragDropService DragDropService;
@inject SpellDetailsCacheService SpellDetailsCacheService;
@inject SavedSpellsService SavedSpellsService;

<PageTitle>All Spells</PageTitle>

<div class="page-banner">
    <span class="tome-header-big">
        TOME OF ALL SPELLS
    </span>
</div>

@if (SpellListItemsCacheService.CachedSpellList.Any())
{
    _spellList = SpellListItemsCacheService.CachedSpellList;
}

@if (_spellList.Any())
{
    <MudContainer MaxWidth=MaxWidth.ExtraLarge Class="pb-4">

        <MudAutocomplete T="SpellListItem"
                         Label="Search Spells"
                         Value="_selectedSpell"
                         ValueChanged="OnSpellSelected"
                         SearchFunc="@SearchSpells"
                         ToStringFunc="@(s => s?.Name)"
                         ResetValueOnEmptyText="true"
                         CoerceText="true"
                         Placeholder="Enter spell name..."
                         Variant="Variant.Outlined"
                         Adornment="Adornment.Start"
                         AdornmentIcon="@Icons.Material.Filled.Search"
                         Class="mb-4" />

        <MudGrid Spacing="3" Justify="Justify.FlexStart">
            @foreach (var spell in _filteredSpellList)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard Class="spell-card" Style="height: 180px;">
                            <MudCardHeader Style="background: linear-gradient(180deg, var(--primary-red-dark) 0%, #4a1510 100%); color: var(--parchment-light); padding: 12px 16px; border-bottom: 2px solid var(--accent-gold);">
                                <CardHeaderContent>
                                    <div @onclick="@(() => OnCardClick(spell))" style="cursor: pointer;">
                                        <MudText Typo="Typo.h6" Style="font-weight: 600; margin-bottom: 4px; font-family: 'Cinzel', serif;">@spell.Name</MudText>
                                        <MudText Typo="Typo.caption" Style="color: var(--accent-gold-light);">
                                            @if (spell.Level == 0)
                                            {
                                                <text>Cantrip</text>
                                            }
                                            else
                                            {
                                                <text>Level @spell.Level</text>
                                            }
                                        </MudText>
                                    </div>
                                </CardHeaderContent>
                                <CardHeaderActions>
                                    @if (IsSpellSaved(spell.Index))
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.BookmarkRemove"
                                                       Color="Color.Warning"
                                                       Size="Size.Small"
                                                       OnClick="@(() => ToggleSpellbook(spell))" />
                                    }
                                    else
                                    {
                                        <MudIconButton Icon="@Icons.Material.Filled.BookmarkAdd"
                                                       Color="Color.Success"
                                                       Size="Size.Small"
                                                       OnClick="@(() => ToggleSpellbook(spell))" />
                                    }
                                </CardHeaderActions>
                            </MudCardHeader>
                            <MudCardContent Style="padding: 8px 16px; background-color: var(--parchment-medium); cursor: pointer; height: 70px; overflow: hidden;" @onclick="@(() => OnCardClick(spell))">
                                <MudText Typo="Typo.caption" Style="color: var(--primary-red-dark); font-weight: 600; margin-bottom: 4px;">
                                    @spell.School @(spell.Level == 0 ? "Cantrip" : $"• Level {spell.Level}")
                                </MudText>
                                <MudText Typo="Typo.body2" Style="color: var(--iron-grey); font-size: 0.7rem; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    @spell.DescPreview
                                </MudText>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
            }
        </MudGrid>
    </MudContainer>

    @* Spell Details Modal Overlay *@
    @if (_showSpellDialog)
    {
        <div class="spell-modal-overlay" @onclick="CloseDialog">
            <div class="spell-modal-content" @onclick:stopPropagation="true">
                <MudPaper Elevation="8" Class="pa-6" Style="max-height: 80vh; overflow-y: auto; background-color: var(--parchment-medium); border: 3px solid var(--accent-gold);">
                    <div class="d-flex justify-space-between align-center mb-4">
                        <MudText Typo="Typo.h4" Style="font-family: 'Cinzel', serif; font-weight: 700; color: var(--primary-red-dark);">@_selectedSpellForDialog?.Name</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="CloseDialog" Color="Color.Default" />
                    </div>

                    @if (_selectedSpellDetails != null)
                    {
                        <div class="d-flex justify-space-between align-center mb-3">
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Style="font-style: italic;">@GetSchoolLevelString(_selectedSpellDetails)</MudText>
                            @if (!string.IsNullOrEmpty(_selectedSpellDetails.Edition))
                            {
                                <MudChip T="string" Size="Size.Small" Color="@(_selectedSpellDetails.Edition == "2024" ? Color.Primary : Color.Secondary)" Style="font-weight: 600;">@_selectedSpellDetails.Edition</MudChip>
                            }
                        </div>
                        <MudDivider Class="my-3" />

                        <div class="spell-stats mb-3">
                            <MudText Typo="Typo.body1" Class="mb-2"><strong>Casting Time:</strong> @_selectedSpellDetails.CastingTime</MudText>
                            <MudText Typo="Typo.body1" Class="mb-2"><strong>Range:</strong> @_selectedSpellDetails.Range</MudText>
                            <MudText Typo="Typo.body1" Class="mb-2"><strong>Components:</strong> @GetComponentsString(_selectedSpellDetails)</MudText>
                            <MudText Typo="Typo.body1" Class="mb-2"><strong>Duration:</strong> @_selectedSpellDetails.Duration</MudText>
                        </div>

                        <MudDivider Class="my-4" />

                        @if (_selectedSpellDetails.Desc.Any())
                        {
                            <div class="spell-description">
                                @foreach (var desc in _selectedSpellDetails.Desc)
                                {
                                    var formattedDesc = _TextFormatterService.FormatBoldWords(System.Net.WebUtility.HtmlEncode(desc));
                                    <MudText Typo="Typo.body1" Class="mb-3">@((MarkupString)formattedDesc)</MudText>
                                }
                            </div>
                        }

                        @if (_selectedSpellDetails.HigherLevel != null && _selectedSpellDetails.HigherLevel.Any())
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.h6" Style="font-weight: 700; color: var(--primary-red-dark);" Class="mb-2">At Higher Levels:</MudText>
                            @foreach (var higherLevel in _selectedSpellDetails.HigherLevel)
                            {
                                <MudText Typo="Typo.body1" Class="mb-2">@higherLevel</MudText>
                            }
                        }

                        <MudDivider Class="my-4" />
                        <div class="d-flex justify-end gap-2">
                            @if (_selectedSpellForDialog != null)
                            {
                                @if (IsSpellSaved(_selectedSpellForDialog.Index))
                                {
                                    <MudButton OnClick="@(() => ToggleSpellbook(_selectedSpellForDialog))" Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.BookmarkRemove">Remove from Spellbook</MudButton>
                                }
                                else
                                {
                                    <MudButton OnClick="@(() => ToggleSpellbook(_selectedSpellForDialog))" Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.BookmarkAdd">Add to Spellbook</MudButton>
                                }
                            }
                            <MudButton OnClick="CloseDialog" Variant="Variant.Filled" Style="background-color: var(--primary-red-dark); color: white;">Close</MudButton>
                        </div>
                    }
                    else
                    {
                        <div class="d-flex justify-center align-center" style="min-height: 200px;">
                            <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
                        </div>
                    }
                </MudPaper>
            </div>
        </div>
    }

}
else
{
    <div class="scrying-container">
        <div class="crystal-orb">
            <div class="orb-glow"></div>
            <div class="orb-inner">
                <div class="magic-swirl"></div>
            </div>
            <div class="orb-reflection"></div>
        </div>
        <h2 class="scrying-title">Divining the Arcane...</h2>
        <p class="scrying-text">The ancient spells are being revealed</p>
        <div class="scrying-runes">
            <span class="rune">᛭</span>
            <span class="rune">ᚨ</span>
            <span class="rune">ᚱ</span>
            <span class="rune">ᚲ</span>
            <span class="rune">᛭</span>
        </div>
    </div>
}

@code {
    private IList<SpellListItem> _spellList = new List<SpellListItem>();
    private string _selectedSpellIndex { get; set; } = string.Empty;

    private IList<SpellListItem> _filteredSpellList = new List<SpellListItem>();
    private SpellListItem? _selectedSpell;

    private bool _isLoadingDetails { get; set; } = false;
    private bool _isActive { get; set; } = false;
    private bool _isInitialized = false;

    // Dialog-related fields
    private bool _showSpellDialog = false;
    private SpellListItem? _selectedSpellForDialog;
    private SpellDetails? _selectedSpellDetails;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isInitialized)
        {
            _isInitialized = true;
            try
            {
                if (!_spellList.Any())
                {
                    await RefreshSpellList();
                }

                _filteredSpellList = _spellList;

                await SavedSpellsService.InitializeSavedSpellsAsync();
                StateHasChanged();
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"Error loading spells: {ex.Message}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Unexpected error during initialization: {ex.Message}");
            }
        }
    }

    #region Spell Loading
    //TODO: move to viewmodel
    private async Task OnRevealSpellsClick()
    {
        await RefreshSpellList();
        // Blazor automatically re-renders the component here, updating the UI
    }

    //TODO: move to viewmodel
    private async Task RefreshSpellList()
    {
        var spellList = await _ApiService.GetSpellsList();
        _spellList = spellList;
        SpellListItemsCacheService.CachedSpellList = spellList;
    }
    #endregion

    #region Spell Search
    private Task<IEnumerable<SpellListItem>> SearchSpells(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult<IEnumerable<SpellListItem>>(_spellList);

        var results = _spellList.Where(x => x.Name.Contains(value, StringComparison.InvariantCultureIgnoreCase));
        return Task.FromResult<IEnumerable<SpellListItem>>(results);
    }

    private void OnSpellSelected(SpellListItem selected)
    {
        _selectedSpell = selected;

        if (selected == null)
        {
            _filteredSpellList = _spellList;
        }
        else
        {
            _filteredSpellList = _spellList.Where(x => x.Index == selected.Index).ToList();
        }

    }
    #endregion

    #region Card and Dialog
    private async Task OnCardClick(SpellListItem spell)
    {
        _selectedSpellForDialog = spell;
        _selectedSpellDetails = null;
        _showSpellDialog = true;
        StateHasChanged();

        // Load spell details
        try
        {
            _selectedSpellDetails = await _ApiService.GetSpellDetails(spell.Index);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading spell details: {ex.Message}");
        }
    }

    private void CloseDialog()
    {
        _showSpellDialog = false;
        _selectedSpellForDialog = null;
        _selectedSpellDetails = null;
    }

    private string GetSchoolLevelString(SpellDetails spell)
    {
        var levelText = spell.Level == 0 ? "Cantrip" : $"Level {spell.Level}";
        var schoolName = spell.School?.Name ?? "Unknown";
        return $"{schoolName} - {levelText}";
    }

    private string GetComponentsString(SpellDetails spell)
    {
        var components = string.Join(", ", spell.Components ?? new List<string>());
        if (!string.IsNullOrEmpty(spell.Material))
        {
            components += $" ({spell.Material})";
        }
        return components;
    }

    private bool IsSpellSaved(string spellIndex)
    {
        return SavedSpellsService.SavedSpellListItems.Any(s => s.Index == spellIndex);
    }

    private async Task ToggleSpellbook(SpellListItem spell)
    {
        if (IsSpellSaved(spell.Index))
        {
            await SavedSpellsService.RemoveSpell(spell.Index);
        }
        else
        {
            await SavedSpellsService.AddSpell(spell.Index);
        }
        StateHasChanged();
    }
    #endregion

}